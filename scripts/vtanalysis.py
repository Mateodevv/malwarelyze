from scripts.utils.logging_config import logger
import re

from vtpython import VirusTotalClient


def _get_entity_reports(entity: str, client: VirusTotalClient):
    reports = []
    # matches for IP addresses
    if re.match(r"\b(?:\d{1,3}\.){3}\d{1,3}\b", entity):
        reports.append(client.get_ip_address_report(entity))
    # matches for URLs/Domains
    elif re.match(r"http|https", entity):
        try:
            # searches if there is a Domain in the given URL
            match = re.search(r"(?:https?:\/\/)?([\w.-]+\.[a-zA-Z]{2,3})", entity)
            if match:
                domain = match.group(1)
                reports.append(client.get_domain_report(domain))
        except Exception as e:
            logger.error(f"Domain check failed. {entity} seems not to be a domain. Error message: {e}")
        try:
            # gets the report for the URL
            reports.append(client.get_url_report(entity))
        except Exception as e:
            logger.error(f"URL VirusTotal Check for {entity} failed. Error message: {e}")
    else:
        # gets the File Report
        reports.append(client.get_file_report(entity))
    return reports


def analyze_entity(entity: str, api_key: str):
    try:
        logger.info("Initializing VirusTotal Client")
        client = VirusTotalClient(api_key)
        logger.info(f"Fetching report for {entity}")
        return _get_entity_reports(entity, client)
    except Exception as e:
        logger.critical(e)
        logger.critical(f"Analysis for {entity} failed")
    # Get the reports for the given entity
    # Send the reports to Graylog server
