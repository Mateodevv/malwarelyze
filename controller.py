import time
import argparse
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from scripts.vtanalysis import analyze_entity
from scripts.utils.logging_config import logger

API_KEY = ""
GRAYLOG_URL = ""
PATH = ""
QUEUE = []


class NewFileHandler(FileSystemEventHandler):
    def on_created(self, event):
        if event.src_path != PATH:
            logger.info(f"New file detected: {event.src_path}")
            QUEUE.append(event.src_path)
            logger.info(f"Current queue of files to analyze: {QUEUE}")

    def on_modified(self, event):
        if event.src_path in QUEUE and event.src_path != PATH:
            return
        self.on_created(event)


def watch_dir(dir_path):
    event_handler = NewFileHandler()
    logger.info("Generated File Handler")
    observer = Observer()
    observer.schedule(event_handler, dir_path, recursive=False)
    logger.info("Starting directory observer")
    observer.start()

    while True:
        time.sleep(5)
        logger.info(f"Current QUEUE: {QUEUE}")
        if QUEUE:
            entity = QUEUE.pop(0)
            logger.info(f"Selecting {entity} from queue")
            try:
                logger.info(f"Starting to analyze entity {entity}")
                analyze_entity(entity=entity, api_key=API_KEY, graylog_url=GRAYLOG_URL)
            except Exception as e:
                logger.error(f"failed to analyze entity {entity}")
                logger.exception(e)
            time.sleep(5)
        else:
            time.sleep(1)


INFO_MSG = '''\

             @      @
     / \     { _____}      / /
   /  |  \___/*******\___/  |  /
  (   I  /   ~   '   ~   \  I   )
   \  |  |   0       0   |  |  /
     \   |       A       |   /
       \__    _______    __/
          \_____________/
    _-------*         *-------_/
   /  /---    Hacking     ---\  /
 /  /     (   System   )      \  /
{  (     (    Gremlin!   )     )  }
 \  \    |               |    /  /
   \  \  |               |  /  /
    **** |               | ****
   //|\\  \_____________/  //|
   *         '*** ***'         *
  ***.       .*** ***.       .***
  '*************' '*************'

usage: myscript.py [--info] \033[91m--dir \033[93m/home\033[0m \033[91m--apikey\033[0m \033[93mkey\033[0m \033[91m--graylog\033[0m \033[93m127.0.0\033[0m

Watch a directory for new files and analyze them with VirusTotal.

\033[93mpositional arguments:\033[0m
  \033[91m--dir\033[0m     Path to directory to monitor
  \033[91m--apikey\033[0m      VirusTotal API key
  \033[91m--graylog\033[0m  Graylog server URL

optional arguments:
  \033[94m-i, --info\033[0m   show this help message and exit"
'''


def _get_queue():
    return QUEUE


def main():
    print(INFO_MSG)
    parser = argparse.ArgumentParser()
    parser.add_argument("--dir", dest="dir_path", help="Path to directory to monitor")
    parser.add_argument("--apikey", dest="api_key", help="VirusTotal API key")
    parser.add_argument("--graylog", dest="graylog_url", help="Graylog server URL")
    args = parser.parse_args()

    if not all([args.dir_path, args.api_key, args.graylog_url]):
        parser.error("All arguments are required")

    global PATH, API_KEY, GRAYLOG_URL
    PATH = args.dir_path
    API_KEY = args.api_key
    GRAYLOG_URL = args.graylog_url
    watch_dir(PATH)


if __name__ == "__main__":
    main()
